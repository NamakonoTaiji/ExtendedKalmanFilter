StormWorksというゲームで、過去に制作した防空システムを改良したいです。

制作当初は4096文字という字数制限のため、とにかく少ない文字数で完成させることを最優先としてシステムを組んだため非常に可読性の低い書き方をしてしまい現在スクリプトの中身がどうなっているのか理解できません。
まずは可読性向上のリファクタリングを行います。


以下に覚えてる限りの詳細な仕様を書き込みます。

構成

* 4つのレーダー(回転前の初期配置...Radar1:Front,Radar2:Right,Radar3:Back,Radar4:Left)を縦に積み上げ、回転ピボットで回転させて全周監視
* それぞれのレーダーは横の視野角0.04,縦の視野角0.22,仰角オフセット+0.11　※回転単位
* 物理センサーで自機座標、姿勢を取得

システム

1. 事前フィルター,圧縮マイコン
入力:
* レーダーから1~32番
出力:
* 圧縮、フィルター済み情報を1~12番
Pack and Filterマイコンで観測した次の更新間隔までの情報をフィルターにかける。Pack and Filterマイコンはレーダー1~4番までのそれぞれに用意するため4つとなる。
入出力最大32chという制限の中で、4つのレーダーからなるべく多くの目標の情報を扱いたいので距離,仰角,方位角の三つの変数をPack関数により圧縮し、変数二つ(pack1,pack2)にまとめて出力。このとき、pack1,pack2に符号をつけることで、それぞれのレーダーの向きの情報も付け加える。

2. 目標情報のリスト化
入力:
* 二つのPack and Filterからそれぞれ1~12番13~24番
出力:
* 整理済みの目標情報を1~12番
Pack and Filterマイコン(レーダー1,レーダー3)、Pack and Filterマイコン(レーダー2,レーダー4)の出力した情報を、それぞれRadarListマイコンで整理して出力する。
これにより24ch分のインプットを12chのみの出力で最適化して渡すことができる。
レーダー1,レーダー3をまとめるRadarListマイコンを"RadarList1"レーダー2,レーダー4をまとめるRadarListマイコンを"RadarList2"と呼称する。
Composite ReadブロックによりPack and Filterマイコン(レーダー1,レーダー3)から出力されるデータをそれぞれComposite Readで1~12番を抽出。
レーダー1の1~12番をRadarList1の1~12番に入力、レーダー3の1~12番をRadarListの13~24番に入力。レーダー2,レーダー4についても同じように処理する。
目標情報は1番から12番に出力され、RadarList1の出力はkalmanfilterマイコンの1~12番、RadarList2の出力はkalmanfilterマイコンの13~24番に対応する。

3. 目標情報をEKFにかけ、高精度な位置の推定、目標同定(データアソシエーション)を行う
入力:
* 二つのRadarListからそれぞれ1~24番
出力:
* targetListの情報(座標のみ)を1~32番
ここが最大の難所。コードの可読性が壊滅している。しかしシステムとしてちゃんと動作しているためおそらくコード的には正しい。
まず、圧縮したp1,p2から距離、方位角、仰角、レーダー番号を取り出す。
取得したデータ"Datas"と既にあるデータ"targetList"をカルマンフィルターにかけた時に一番都合のいいデータを同じ目標として同定する。
更新したtargetListを出力する。

思うこと:
* Pack and Filterで目標の角度をグローバル角度にしてから渡す方が賢い気がする。